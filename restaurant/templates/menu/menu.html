{% extends 'menu/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet">

<div class="container py-4">

    <h2 class="mb-4 text-center">üçΩ Our Menu</h2>

    <!-- MAIN CATEGORY FILTER -->
    <div class="d-flex justify-content-center gap-2 mb-4">
        <button class="btn btn-outline-dark main-filter active" data-filter="all">All</button>
        {% for category in categories %}
            <button class="btn btn-outline-dark main-filter"
                    data-filter="{{ category.category_name|lower }}">
                {{ category.category_name }}
            </button>
        {% endfor %}
    </div>

    <!-- ================= ALL ITEMS (ONLY FOR ALL BUTTON) ================= -->
    <div id="all-items" class="row">

        {% for category in categories %}
            {% for sub in category.fooditemsubcategory_set.all %}
                {% for item in sub.fooditem_set.all %}
                    {% if item.is_available %}

                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3 food-item" data-sub="{{ sub.subcategory_name|lower }}">
                        <div class="card food-card shadow-sm h-100" data-food-id="{{ item.id }}">

                            {% if item.images.first %}
                            <div class="image-box"
                                 style="--bg-img: url('{{ item.images.first.img_url.url }}');">
                                <img src="{{ item.images.first.img_url.url }}">
                            </div>
                            {% endif %}

                            <div class="card-body">
                                <h6 class="card-title">{{ item.name }}</h6>
                                <div class="price">‚Çπ {{ item.price }}</div>
                                <div class="calories">{{ item.calories }} cal</div>

                                <div class="cart-action mt-1">
                                    {% if user.is_authenticated %}
                                        <button class="add-cart-btn btn btn-success btn-sm">üõí Add</button>
                                    {% else %}
                                        <button class="btn btn-success btn-sm"
                                                onclick="alert('Please login first!')">üõí Add</button>
                                    {% endif %}
                                </div>
                            </div>

                        </div>
                    </div>

                    {% endif %}
                {% endfor %}
            {% endfor %}
        {% endfor %}

    </div>
    <!-- ================= END ALL ITEMS ================= -->

    <!-- ================= CATEGORY ITEMS ================= -->
    <div id="category-items" style="display:none;">

        {% for category in categories %}
        <div class="category-block" data-category="{{ category.category_name|lower }}">

            <!-- SUB CATEGORY -->
            <div class="subcategory-filter mb-3">
                <button class="btn btn-sm btn-outline-dark sub-filter active" data-sub="all">All</button>
                {% for sub in category.fooditemsubcategory_set.all %}
                    <button class="btn btn-sm btn-outline-dark sub-filter"
                            data-sub="{{ sub.subcategory_name|lower }}">
                        {{ sub.subcategory_name }}
                    </button>
                {% endfor %}
            </div>

            <div class="row category-food-items">
                {% for sub in category.fooditemsubcategory_set.all %}
                    {% for item in sub.fooditem_set.all %}
                        {% if item.is_available %}

                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3 food-item" data-sub="{{ sub.subcategory_name|lower }}">
                            <div class="card food-card shadow-sm h-100" data-food-id="{{ item.id }}">

                                {% if item.images.first %}
                                <div class="image-box"
                                     style="--bg-img: url('{{ item.images.first.img_url.url }}');">
                                    <img src="{{ item.images.first.img_url.url }}">
                                </div>
                                {% endif %}

                                <div class="card-body">
                                    <h6 class="card-title">{{ item.name }}</h6>
                                    <div class="price">‚Çπ {{ item.price }}</div>
                                    <div class="calories">{{ item.calories }} cal</div>

                                    <div class="cart-action mt-1">
                                        {% if user.is_authenticated %}
                                            <button class="add-cart-btn btn btn-success btn-sm">üõí Add</button>
                                        {% else %}
                                            <button class="btn btn-success btn-sm"
                                                    onclick="alert('Please login first!')">üõí Add</button>
                                        {% endif %}
                                    </div>
                                </div>

                            </div>
                        </div>

                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </div>

        </div>
        {% endfor %}

    </div>
    <!-- ================= END CATEGORY ITEMS ================= -->

</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

    const mainFilters = document.querySelectorAll('.main-filter');
    const categories = document.querySelectorAll('.category-block');

    mainFilters.forEach(btn => {
        btn.addEventListener('click', () => {

            mainFilters.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const filter = btn.dataset.filter;

            if (filter === 'all') {
                document.getElementById('all-items').style.display = 'flex';
                document.getElementById('category-items').style.display = 'none';
            } else {
                document.getElementById('all-items').style.display = 'none';
                document.getElementById('category-items').style.display = 'block';

                categories.forEach(cat => {
                    cat.style.display =
                        (cat.dataset.category === filter) ? 'block' : 'none';
                });
            }
        });
    });

    // Subcategory filtering
    document.querySelectorAll('.sub-filter').forEach(btn => {
        btn.addEventListener('click', () => {
            const sub = btn.dataset.sub;
            const cat = btn.closest('.category-block');

            // Remove active class
            cat.querySelectorAll('.sub-filter').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Show/hide cards inside this category
            cat.querySelectorAll('.category-food-items .food-item').forEach(card => {
                card.style.display = (sub === 'all' || card.dataset.sub === sub) ? 'block' : 'none';
            });
        });
    });

    // Subcategory filter for ALL view
    document.querySelectorAll('#all-items .food-item').forEach(card => {
        // we already have data-sub attribute, JS filtering if needed
    });

});
</script>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="{% static 'menu/js/cart.js' %}"></script>
{% endblock %}
